name: Push master -> PeerReviewBranch on Azure Repos (bash)

on:
  push:
    branches:
      - master

jobs:
  push-master-to-peerreview:
    runs-on: self-hosted    # if your runner's only label is self-hosted, this will target it
    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          ref: refs/heads/master


      - name: Push master -> PeerReviewBranch on Azure Repos
        env:
          AZDO_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
        run: |
          set -euo pipefail
          if [ -z "${AZDO_PAT:-}" ]; then
            echo "Error: AZURE_DEVOPS_PAT secret missing" >&2
            exit 1
          fi

          SRC_BRANCH="master"
          TGT_BRANCH="PeerReviewBranch"
          # Use https if available; change to http if you absolutely must (not recommended)
          AZDO_URL="https://x:${AZDO_PAT}@cdp-devops.net.dcs.hull.ac.uk/CDPProjects/2526%20-%20Pixel%20Cats/_git/PixelCats"

          # Ensure we are on master and up-to-date (checkout above already sets ref)
          git checkout -B "${SRC_BRANCH}"

          # Add/update remote and push
          if ! git remote get-url azure >/dev/null 2>&1; then
            git remote add azure "${AZDO_URL}"
          else
            git remote set-url azure "${AZDO_URL}"
          fi

          git push azure "refs/heads/${SRC_BRANCH}:refs/heads/${TGT_BRANCH}" --follow-tags
        shell: bash
